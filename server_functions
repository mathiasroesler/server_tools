#!/bin/bash

#########################################################
### Helper functions.                      		#
### Last modified: 02/2021		   		#
### Author: Mathias Roesler		   		#
### Contact: mathias.roesler@univ-reims.fr 		#
#########################################################


function define_const() {
	# Defines the constants values of the script.
	# 
	# Arguments:
	# Returns:
	#
	NAME=`basename $0`

	if [[ ! -f $HOME/.servers ]]; then
		echo "Server file not found."
		echo "Creating server file at $HOME."
		echo ""
		touch $HOME/.servers
	fi

	SERVER_FILE=$HOME/.servers
	NB_SERVERS=$(wc -l < $SERVER_FILE)
	SERVER=true

return 0
}

function set_connection_params() {
	# Set the connection server, port and options.
	#
	# If the number of the server is not available, an error is raised.
	# Arguments: 
	# $1 -- server name or number.
	# Returns:
	#

	server_check $1

	# Read the params from file if not specified by user.
	if [[ $SERVER == false ]]; then
		server_params=$(sed "${1}q;d" $SERVER_FILE)
		readarray -d " " -t params<<<${server_params} # Parse line.

		server=${params[0]}

		if [[ $PORT == false ]]; then
			port_number=${params[1]}
		fi

		if [[ $OPTION == false ]]; then
			options=${params[@]:2}
		fi

	else
		server=$1

		if [[ $PORT == false ]]; then
			port_number=22
		fi
	fi

return 0
}


function print_options() {
	# Prints the available options.
	#
	# Arguments:
	# $1 -- recursive
	# Returns:
	#
	echo "Options:"
	echo " -h, print help."
	echo " -l, lists the available servers."

	if [[ $1 == true ]]; then
		echo " -r, copy directories recursively."
	fi

	echo " -p port, specify port number."
	echo " -o options, specify (in quotations) the options."

return 0
}


function print_info() {
	# Prints the connection information.
	#
	# Arguments:
	# Returns:
	#
	printf "Server: "
	echo $server
	printf "Port: "
	echo $port_number

	# Print options if not empty.
	if [[ -n $options ]]; then
		printf "Options: "
		echo $options
	fi

	# Print files if not empty.
	if [[ -n $files ]]; then
		printf "Source: "
		echo $files
	fi

	# Print destination if not empty.
	if [[ -n $destination ]];then
		printf "Destination: "
		echo $destination
	fi

return 0
}


function available_servers() {
	# Prints the available servers in the server file.
	#
	# Arguments:
	# Returns:
	#
	echo ""
	echo "There are currently $NB_SERVERS available servers:"
	cpt=1

	while read line
	do
		readarray -d " " -t word<<<${line}
		echo " $cpt: ${word[0]}"
		cpt=$((cpt+1))
	done < "$SERVER_FILE"

	echo ""

	printf "The list of servers is stored in $SERVER_FILE in the following fashion: "
	echo "username@hostname port options"
	echo "You can add a server by editing the file directly."

return 0
}

########################################
####### ERROR HANDLING FUNCTIONS #######
########################################

function error_handler() {
	# Handles errors.
	#
	# Arguments:
	# $1 -- error message.
	# Returns:
	#
	echo "$NAME: $1"
	echo "Try '$NAME -h' for help."
	exit 1

return 0
}


function server_check() {
	# Checks if the provide server is a valid choice.
	#
	# Arguments:
	# $1 -- val
	# Returns:
	#
	if [[ $1 =~ ^[0-9]+$ ]]; then
		SERVER=false
	fi

	if [[ $SERVER == false ]]; then
		if [[ $1 -gt $NB_SERVERS ]]; then
			error_handler "invalid server choice."
		fi
	fi

return 0
}


function argument_nb_check() {
	# Checks if the right number of arguments was provided.
	#
	# Arguments:
	# $1 -- arg_nb
	# $2 -- desired_nb
        # Returns:
	#
	if [[ $1 -lt $2 ]]; then
		error_handler "not enough arguments."
	
	elif [[ $1 -gt $2 ]]; then
		if [[ $NAME == "remote-connection" ]]; then
			error_handler "too many arguments."
		fi
	fi

return 0
}
